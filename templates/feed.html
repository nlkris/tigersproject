<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIGINSA ‚Äî Fil d‚Äôactualit√©</title>
<style>
:root {
  --bg:#0f1724; --card:#0b1220; --muted:#9aa8bf; --accent:#5eead4;
  --radius:12px; --shadow:0 6px 18px rgba(2,6,23,0.6);
  font-family: Inter, sans-serif;
}
* { box-sizing:border-box; margin:0; padding:0; }

body {
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  background: linear-gradient(135deg,#071226,#0f1724);
  color:#e6eef8;
  font-size:16px;
  padding:20px;
}

.container {
  background:var(--card);
  padding:32px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  width:100%;
  max-width:1100px;
}

/* en-t√™te */
.header-top {
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:16px;
  margin-bottom:12px;
}

.profile-shortcut {
  display:flex;
  align-items:center;
  gap:10px;
  text-decoration:none;
  color:var(--accent);
  font-weight:600;
  transition:0.2s;
}
.profile-shortcut svg {
  width:70px;
  height:70px;
  cursor:pointer;
  transition: transform 0.3s ease, filter 0.3s ease;
}
.profile-shortcut:hover svg {
  transform: scale(1.05);
  filter: drop-shadow(0 0 12px var(--accent));
}


.notif-shortcut {
    float: left;
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--accent);
    font-weight: 600;
    transition: 0.2s;
}
.notif-shortcut .notif-icon {
    width: 70px;
    height: 70px;
    cursor: pointer;
    transition: transform 0.3s ease, filter 0.3s ease;
}
.notif-shortcut:hover .notif-icon {
    transform: scale(1.05);
    filter: drop-shadow(0 0 12px var(--accent));
}

/* logo + barre */
.header-center {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
  margin-bottom:24px;
}

.logo {
  display:block;
  margin:0 auto 4px auto;
  width:200px;
  height:auto;
}
.logo:hover {
  transform:scale(1.05);
  filter: drop-shadow(0 0 12px var(--accent));
}

/* nouvelle barre sous logo */
.search-bar {
  width:100%;
  max-width:420px;
  position:relative;
}
.search-bar input {
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.05);
  color:#e6eef8;
  outline:none;
}

/* suggestions */
#search-suggestions {
  background:rgba(11,18,32,0.95);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;
  margin-top:6px;
  padding:0;
  list-style:none;
  display:none;
  position:absolute;
  width:100%;
  z-index:100;
}
#search-suggestions li {
  padding:10px;
  cursor:pointer;
  color:var(--accent);
}
#search-suggestions li:hover {
  background:rgba(94,234,212,0.15);
}

.switch-container {
  display:flex;
  justify-content:center;
  gap:24px;
  margin-bottom:24px;
}
.switch-btn {
  display:flex;
  align-items:center;
  justify-content:center;
  width:60px;
  height:60px;
  border-radius:50%;
  background: rgba(255,255,255,0.05);
  color: var(--accent);
  text-decoration:none;
  transition: all 0.3s ease;
  font-size:24px;
}
.switch-btn:hover {
  background: rgba(94,234,212,0.25);
  filter: drop-shadow(0 0 10px #5eead4);
}
.switch-btn.active {
  background: linear-gradient(90deg,#06b6d4,#7c3aed);
  color: #021024;
  box-shadow: var(--shadow);
}

.feed-container { display:flex; flex-direction:column; gap:16px; }
.feed {
  background:rgba(255,255,255,0.03);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}
.post {
  position: relative;
  padding: 12px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  margin-bottom: 12px;
  overflow: visible;
  max-width: 100%;
}
.post strong { color: var(--accent); }
.post p { margin:6px 0; }
.post img {
  width:50px;
  height:50px;
  border-radius:50%;
  object-fit:cover;
  flex-shrink:0;
  border:2px solid var(--accent);
  cursor:pointer;
}

/* POST BUTTONS - Under tweet in a line */
.post-buttons {
  display: flex;
  gap: 20px;
  margin-top: 12px;
  padding-left: 62px; /* Align with tweet content */
}

.post-buttons button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.post-buttons button:hover {
  background: rgba(94, 234, 212, 0.1);
  border-color: var(--accent);
  color: var(--accent);
  transform: scale(1.05);
}

/* Specific button styles */
.like-btn.liked {
  color: #f87171 !important;
  border-color: #f87171 !important;
}

.retweet-btn.retweeted {
  color: var(--accent) !important;
  border-color: var(--accent) !important;
}

/* Button counts */
.post-buttons button span {
  font-size: 12px;
  font-weight: 600;
}

.view-comments-btn {
  /* Add styling to match others */
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.view-comments-btn:hover {
  background: rgba(94, 234, 212, 0.1);
  border-color: var(--accent);
  color: var(--accent);
  transform: scale(1.05);
}

.profile-pic {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

/* Tweet gallery */
.tweet-grid {
  display: grid;
  gap: 6px;
  margin-top: 10px;
  grid-template-columns: repeat(auto-fit, minmax(160px, 160px));
}
.tweet-grid .tweet-img {
  width: 160px;
  height: 160px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid var(--accent);
  cursor: pointer;
  display: block;
}
.post img:not(.tweet-img) {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid var(--accent);
  cursor: pointer;
}

/* Modal */
.img-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.img-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
}
/* Logout button */
.logout-shortcut {
  float: left;
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: var(--accent);
  font-weight: 600;
  transition: 0.2s;
}
.logout-shortcut .logout-icon {
  width: 70px;
  height: 70px;
  cursor: pointer;
  transition: transform 0.3s ease, filter 0.3s ease;
}
.logout-shortcut:hover .logout-icon {
  transform: scale(1.05);
  filter: drop-shadow(0 0 12px var(--accent));
}

/* Update header-top to space buttons properly */
.header-top {
  display: flex;
  justify-content: space-between; /* Changed from flex-end */
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}

form { display:flex; flex-direction:column; gap:16px; margin-bottom:32px; }
textarea {
  padding:10px 12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
  background:transparent;
  color:#e6eef8;
  outline:none;
  width:100%;
  min-height:80px;
}
button {
  padding:12px;
  background:linear-gradient(90deg,#06b6d4,#7c3aed);
  border:none;
  border-radius:8px;
  color:#021024;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
}
button:hover { opacity:0.9; }
/* Retweet button */

.comment {
  background: rgba(255,255,255,0.05);
  padding: 8px;
  border-radius: 8px;
}
.comment .reply {
  margin-left: 20px;
  background: rgba(94,234,212,0.05);
  padding: 6px;
  border-radius: 6px;
}
.comment button.reply-btn {
  background:none;
  border:none;
  color: var(--accent);
  cursor:pointer;
  font-size: 14px;
  margin-top:4px;
}

/* Modal de commentaires - Match profile style */
.comments-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.comments-modal-content {
  background: rgba(11, 18, 32, 0.95);
  border-radius: 12px;
  padding: 20px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  border: 1px solid rgba(94, 234, 212, 0.3);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.comments-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.comments-modal-title {
  color: var(--accent);
  font-size: 18px;
  font-weight: 600;
}

.close-comments-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.close-comments-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--accent);
}

/* Comment styling to match profile */
.comment-item {
  background: rgba(255, 255, 255, 0.05);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.comment-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.comment-profile-pic {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--accent);
}

.comment-username {
  color: var(--accent);
  font-weight: 600;
  font-size: 14px;
}

.comment-content {
  color: #e6eef8;
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 8px;
}

.comment-reply {
  margin-left: 20px;
  background: rgba(94, 234, 212, 0.05);
  padding: 8px;
  border-radius: 6px;
  margin-top: 6px;
  border-left: 2px solid var(--accent);
}

.comment-reply .comment-username {
  font-size: 13px;
}

.reply-btn {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.reply-btn:hover {
  background: rgba(94, 234, 212, 0.1);
}

/* Form styling */
.comment-form-container {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.comment-form-container textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
  color: #e6eef8;
  outline: none;
  font-size: 14px;
  resize: vertical;
  min-height: 60px;
  margin-bottom: 10px;
}

.comment-form-container button[type="submit"] {
  padding: 8px 16px;
  background: linear-gradient(90deg, #06b6d4, #7c3aed);
  border: none;
  border-radius: 8px;
  color: #021024;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

.comment-form-container button[type="submit"]:hover {
  opacity: 0.9;
}

.comment-profile-pic {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid var(--accent);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.comment-profile-pic:hover {
  transform: scale(1.1);
  box-shadow: 0 0 10px rgba(94, 234, 212, 0.5);
}

.comment-username {
  color: var(--accent);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer; /* Make it look clickable */
  transition: all 0.2s ease;
  display: inline-block; /* Better click area */
  padding: 2px 4px;
  border-radius: 4px;
}

.comment-username:hover {
  text-decoration: underline;
  background: rgba(94, 234, 212, 0.1);
}

/* For reply usernames */
.comment-reply .comment-username {
  font-size: 13px;
  color: var(--accent);
  cursor: pointer;
}

.comment-reply .comment-username:hover {
  text-decoration: underline;
  background: rgba(94, 234, 212, 0.05);
}

/* Search Modal */
.search-modal {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  max-height: 400px;
  overflow-y: auto;
  background: rgba(11, 18, 32, 0.98);
  border: 1px solid rgba(94, 234, 212, 0.3);
  border-radius: 8px;
  margin-top: 8px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.search-modal-content {
  padding: 12px;
}

.search-result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid transparent;
}

.search-result-item:hover {
  background: rgba(94, 234, 212, 0.15);
  border-color: var(--accent);
  transform: translateX(4px);
}

.search-result-item img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
}

.search-result-info {
  flex: 1;
}

.search-result-username {
  color: var(--accent);
  font-weight: 600;
  font-size: 16px;
}

.search-result-follow {
  background: linear-gradient(90deg, #06b6d4, #7c3aed);
  border: none;
  border-radius: 20px;
  color: #021024;
  padding: 6px 16px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.search-result-follow:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(94, 234, 212, 0.5);
}

.search-result-follow.following {
  background: rgba(255, 255, 255, 0.1);
  color: var(--muted);
  border: 1px solid var(--muted);
}

/* Search input focus state */
#live-search:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(94, 234, 212, 0.2);
}

/* No results message */
.no-results {
  text-align: center;
  color: var(--muted);
  padding: 20px;
  font-style: italic;
}

a { color:var(--accent); text-decoration:none; }
a:hover { text-decoration:underline; }

/* Flash Messages */
#flash-messages-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 350px;
}

.flash-message {
  padding: 15px 20px;
  border-radius: 8px;
  color: #021024;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.flash-message.success {
  background: linear-gradient(90deg, #10b981, #34d399);
}

.flash-message.error {
  background: linear-gradient(90deg, #ef4444, #f87171);
}

.flash-message.info {
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
}

.flash-close {
  background: none;
  border: none;
  color: #021024;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background-color 0.2s;
}

.flash-close:hover {
  background-color: rgba(2, 16, 36, 0.1);
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100%);
  }
}

/* Remove old flashes style */
.flashes {
  display: none; /* Hide old style */
}

.flashes {
  list-style:none;
  padding:0;
  margin-bottom:16px;
  text-align:center;
}
.flashes li {
  font-size:14px;
  margin-bottom:8px;
  padding:8px 16px;
  border-radius:8px;
  display:inline-block;
}
.flashes li.success { color:#021024; background:rgba(94,234,212,1); }
.flashes li.error   { color:#021024; background:rgba(248,113,113,1); }
.flashes li.info    { color:#021024; background:rgba(94,165,255,1); }
</style>
</head>
<body>
<div class="container">

<!-- HEADER TOP : Logout + Notifications + Profil -->
<div class="header-top">
  <!-- Bouton D√©connexion (NEW) - Top Left -->
  <a href="{{ url_for('routes.logout') }}" class="logout-shortcut" title="D√©connexion">
    <svg viewBox="0 0 24 24" fill="none" class="logout-icon">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="#5eead4" stroke-width="1.6" stroke-linecap="round"/>
      <path d="M16 17l5-5-5-5" stroke="#5eead4" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M21 12H9" stroke="#5eead4" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
  </a>

  <!-- Bouton Notifications -->
  <a href="{{ url_for('routes.notifications') }}" class="notif-shortcut" title="Voir mes notifications">
    <svg viewBox="0 0 24 24" fill="none" class="notif-icon">
      <path d="M12 2c-3 0-5 2.2-5 5v2.2c0 .6-.3 1.2-.8 1.6L4 13v1h16v-1l-2.2-2.2c-.5-.4-.8-1-.8-1.6V7c0-2.8-2-5-5-5z"
            stroke="#5eead4" stroke-width="1.6" stroke-linecap="round"
            stroke-linejoin="round"/>
      <path d="M10 18a2 2 0 004 0" stroke="#5eead4" stroke-width="1.6"
            stroke-linecap="round"/>
    </svg>
  </a>

  <!-- Profil -->
  <a href="{{ url_for('routes.profile', username=current_user.username) }}" class="profile-shortcut">
    <svg viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 0 10px #5eead4);">
      <circle cx="12" cy="12" r="10" stroke="#5eead4" stroke-width="0.8" style="filter: blur(3px); opacity:0.55;"></circle>
      <circle cx="12" cy="12" r="9" stroke="#5eead4" stroke-width="1.5"/>
      <circle cx="12" cy="8" r="3.2" stroke="#5eead4" stroke-width="1.6"/>
      <path d="M5.5 19.5c1.4-3.5 4.3-5.5 6.5-5.5s5.1 2 6.5 5.5" stroke="#5eead4" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
  </a>
</div>

<!-- FLASH MESSAGES (Auto-hide after 3 seconds) -->
<div id="flash-messages-container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message {{ category }}" data-delay="3000">
          {{ message }}
          <button class="flash-close" onclick="this.parentElement.remove()">√ó</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

  <!-- LOGO + NOUVELLE BARRE -->
  <div class="header-center">
    <img src="{{ url_for('static', filename='tiger.png') }}" alt="Logo TIGINSA" class="logo">

    <div class="search-bar">
      <input type="text" id="live-search" placeholder="Rechercher des utilisateurs..." autocomplete="off">
      <div id="search-results-modal" class="search-modal">
        <div class="search-modal-content">
          <div id="search-results-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FORMULAIRE TWEET -->
  <form method="POST" enctype="multipart/form-data">
    <textarea name="content" placeholder="Quoi de neuf ?"></textarea>
    <input type="file" name="images" accept="image/*" multiple>
    <button type="submit">Publier</button>
  </form>

  <!-- SWITCH VUE -->
  <div class="switch-container">
    <a href="{{ url_for('routes.feed', view='followed') }}" class="switch-btn {% if view == 'followed' %}active{% endif %}">&#10148;</a>
    <a href="{{ url_for('routes.feed', view='recommended') }}" class="switch-btn {% if view == 'recommended' %}active{% endif %}">&#9733;</a>
  </div>

  <!-- FEED -->
  <div class="feed-container">
    {% set tweet_lists = {'followed': followed_tweets, 'recommended': recommended_tweets} %}
    <div class="feed">
      <h2>{{ 'Abonnements' if view == 'followed' else 'Recommandations' }}</h2>
      {% if tweet_lists[view] %}
        {% for post in tweet_lists[view] %}
          {% set user_obj = users | selectattr('username','equalto',post.username) | first %}

          <div class="post" id="post-{{ post.id }}" data-post-id="{{ post.id }}">

            <div style="display:flex; align-items:flex-start; gap:12px;">
              <!-- Profile pic -->
              <img src="{{ user_obj.profile_pic_url if user_obj and user_obj.profile_pic_url else url_for('static', filename='default-avatar.png') }}"
                   alt="Profil"
                   onclick="window.location.href='{{ url_for('routes.profile', username=post.username) }}'"
                   style="cursor:pointer;">
              <div style="flex:1;">
                <!-- Username -->
                <strong style="cursor:pointer;"
                        onclick="window.location.href='{{ url_for('routes.profile', username=post.username) }}'">
                  {{ post.username }}
                </strong>
                <!-- Text content -->
                <p>{{ post.content }}</p>
                <!-- Tweet image -->
                {% if post.image_urls %}
                  <div class="tweet-grid">
                    {% for img in post.image_urls %}
                      <img src="{{ img }}" class="tweet-img" onclick="openImageModal('{{ img }}')">
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

          <div class="post-buttons">
            <button class="retweet-btn {% if session['user_id'] in post.get('retweets', []) %}retweeted{% endif %}"
                    data-tweet-id="{{ post.id }}">
              üîÑ <span class="retweet-count">{{ post.get('retweets', [])|length }}</span>
            </button>

            <button class="like-btn {% if post.liked %}liked{% endif %}" data-tweet-id="{{ post.id }}">
              ‚ù§Ô∏è <span class="like-count">{{ post.likes|length }}</span>
            </button>

            <button class="view-comments-btn" data-tweet-id="{{ post.id }}">
              üí¨ <span class="comment-count">{{ post.get('comments', [])|length }}</span>
            </button>
          </div>

          </div>
        {% endfor %}
      {% else %}
        <p style="text-align:center; color:var(--muted);">
          {% if view == 'followed' %}
            Aucun tweet de vos abonnements.
          {% else %}
            Aucune recommandation pour le moment.
          {% endif %}
        </p>
      {% endif %}
    </div>
  </div>

<!-- MODAL COMMENTAIRES (Updated to match profile) -->
<div id="commentsModal" class="comments-modal">
  <div class="comments-modal-content">
    <div class="comments-modal-header">
      <h3 class="comments-modal-title">Commentaires</h3>
      <button class="close-comments-btn" onclick="closeCommentModal()">√ó</button>
    </div>
    
    <div id="commentsList"></div>
    
    <div class="comment-form-container">
      <form id="newCommentForm">
        <textarea name="content" placeholder="Ajouter un commentaire..." required></textarea>
        <button type="submit">Commenter</button>
      </form>
    </div>
  </div>
</div>



  <script>
/* LIKE AJAX */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const tweetId = btn.dataset.tweetId;
      const countEl = btn.querySelector('.like-count');
      btn.disabled = true;
      try {
        const res = await fetch(`/like/${tweetId}`, { method:'POST' });
        const data = await res.json();
        if(data.success){
          countEl.textContent = data.like_count;
          btn.classList.toggle('liked', data.liked);
        }
      } finally {
        btn.disabled = false;
      }
    });
  });
});

/* ENHANCED LIVE SEARCH WITH MODAL */
let currentFollowing = new Set(); // Store followed users

// Load current user's following list
async function loadFollowing() {
  try {
    const res = await fetch('/api/current_user');
    if (res.ok) {
      const user = await res.json();
      currentFollowing = new Set(user.following || []);
    }
  } catch (error) {
    console.error('Error loading following:', error);
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadFollowing);

// Search input handler
document.getElementById("live-search").addEventListener("input", async function () {
  const q = this.value.trim();
  const modal = document.getElementById("search-results-modal");
  const resultsList = document.getElementById("search-results-list");

  if (!q) {
    modal.style.display = "none";
    return;
  }

  try {
    const res = await fetch(`/search_live?q=${encodeURIComponent(q)}`);
    const users = await res.json();

    if (!users.length) {
      resultsList.innerHTML = '<div class="no-results">Aucun utilisateur trouv√©</div>';
      modal.style.display = "block";
      return;
    }

    // Render search results
    resultsList.innerHTML = users.map(user => `
      <div class="search-result-item" data-user-id="${user.id}">
        <img src="${user.profile_pic_url || '/static/default-avatar.png'}" 
             alt="${user.username}"
             onclick="window.location.href='/profile/${user.username}'">
        <div class="search-result-info" onclick="window.location.href='/profile/${user.username}'">
          <div class="search-result-username">@${user.username}</div>
        </div>
        <button class="search-result-follow ${currentFollowing.has(user.id) ? 'following' : ''}"
                data-user-id="${user.id}"
                data-username="${user.username}">
          ${currentFollowing.has(user.id) ? 'Suivi' : 'Suivre'}
        </button>
      </div>
    `).join('');

    modal.style.display = "block";

    // Add follow/unfollow handlers
    document.querySelectorAll('.search-result-follow').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const username = btn.dataset.username;
        const userId = btn.dataset.userId;
        
        const res = await fetch(`/toggle_follow/${username}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (res.ok) {
          const data = await res.json();
          if (data.is_following) {
            currentFollowing.add(parseInt(userId));
            btn.textContent = 'Suivi';
            btn.classList.add('following');
          } else {
            currentFollowing.delete(parseInt(userId));
            btn.textContent = 'Suivre';
            btn.classList.remove('following');
          }
        }
      });
    });

  } catch (error) {
    console.error('Search error:', error);
    resultsList.innerHTML = '<div class="no-results">Erreur de recherche</div>';
    modal.style.display = "block";
  }
});

// Close modal when clicking outside
document.addEventListener("click", (e) => {
  const modal = document.getElementById("search-results-modal");
  const searchInput = document.getElementById("live-search");
  
  if (!modal.contains(e.target) && e.target !== searchInput) {
    modal.style.display = "none";
  }
});

// Keep modal open when clicking inside it
document.getElementById("search-results-modal").addEventListener("click", (e) => {
  e.stopPropagation();
});

document.addEventListener("click", (e) => {
  const box = document.getElementById("search-suggestions");
  if (!box.contains(e.target) && e.target.id !== "live-search") {
    box.style.display = "none";
  }
});
</script>

<!-- Image modal -->
<div id="imgModal" class="img-modal" onclick="closeImageModal()">
  <img id="modalImage">
</div>

<script>
function openImageModal(src) {
  document.getElementById("modalImage").src = src;
  document.getElementById("imgModal").style.display = "flex";
}

function closeImageModal() {
  document.getElementById("imgModal").style.display = "none";
}



</script>

<script>
  /* AJAX COMMENT SUBMISSION */
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      const result = await response.json();
      if (result.success) {
        // Recharge la page pour afficher le nouveau commentaire
        window.location.reload();
      } else {
        alert(result.message);
      }
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Gestion des likes sur les commentaires
    document.querySelectorAll('.like-comment-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const tweetId = btn.dataset.tweetId;
            const commentIndex = btn.dataset.commentIndex;
            const countEl = btn.querySelector('.like-count');

            btn.disabled = true;

            try {
                const response = await fetch(`/like_comment/${tweetId}/${commentIndex}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la requ√™te');
                }

                const data = await response.json();

                if (data.success) {
                    // Met √† jour le nombre de likes
                    countEl.textContent = data.like_count;
                    // Met √† jour l'√©tat visuel du bouton
                    btn.classList.toggle('liked', data.liked);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue');
            } finally {
                btn.disabled = false;
            }
        });
    });
});
</script>


<script>
  /* AJAX RETWEET SUBMISSION */
document.addEventListener("DOMContentLoaded", () => {

  document.querySelectorAll(".retweet-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const tweetId = btn.dataset.tweetId;
      const countEl = btn.querySelector(".retweet-count");

      btn.disabled = true;

      try {
        const res = await fetch(`/retweet/${tweetId}`, { method: "POST" });
        const data = await res.json();

        if (!data.success) throw new Error(data.error || "Erreur");

        // Change l'√©tat visuel du bouton
        btn.classList.toggle("retweeted", data.is_retweeted);

        // Mets √† jour le compteur
        countEl.textContent = data.retweet_count;

      } catch (err) {
        console.error(err);
        alert("Erreur retweet : " + err.message);
      } finally {
        btn.disabled = false;
      }
    });
  });

});
   
</script>

<script>
/* AJAX MODAL COMMENTAIRES - Updated to match profile */
let currentTweetId = null;

// Ouvrir modal avec commentaires
document.querySelectorAll('.view-comments-btn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    currentTweetId = btn.dataset.tweetId;
    document.getElementById('commentsModal').style.display = 'flex';
    await loadComments(currentTweetId);
  });
});

// Close modal with X button or clicking outside
function closeCommentModal() {
  document.getElementById('commentsModal').style.display = 'none';
  document.getElementById('commentsList').innerHTML = '';
  currentTweetId = null;
}

// Close when clicking outside modal
document.addEventListener('click', (e) => {
  const modal = document.getElementById('commentsModal');
  if (modal.style.display === 'flex' && e.target === modal) {
    closeCommentModal();
  }
});

// Charger les commentaires (updated with profile pictures)
async function loadComments(tweetId) {
  try {
    const res = await fetch(`/comments/${tweetId}`);
    const data = await res.json();
    const container = document.getElementById('commentsList');
    container.innerHTML = '';

    if (data.success && data.comments && data.comments.length > 0) {
      data.comments.forEach((comment, idx) => {
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('comment-item');
        
        // Cr√©er HTML du commentaire principal AVEC PHOTO DE PROFIL
        let commentHtml = `
          <div class="comment-header">
            <img src="${comment.profile_pic_url || '/static/default-avatar.png'}" 
                class="comment-profile-pic" 
                alt="${comment.username}"
                onclick="window.location.href='/profile/${comment.username}'"
                style="cursor:pointer;">
            <strong class="comment-username" 
                    onclick="window.location.href='/profile/${comment.username}'"
                    style="cursor:pointer;">
              ${comment.username}
            </strong>
          </div>
          <div class="comment-content">${comment.content}</div>
          <button class="reply-btn" data-index="${idx}">R√©pondre</button>
        `;
        
        // Ajouter les r√©ponses si elles existent AVEC PHOTOS DE PROFIL
        if (comment.replies && comment.replies.length > 0) {
          commentHtml += '<div class="comment-replies" style="margin-top: 8px;">';
          comment.replies.forEach(reply => {
          commentHtml += `
            <div class="comment-reply">
              <div class="comment-header">
                <img src="${reply.profile_pic_url || '/static/default-avatar.png'}" 
                    class="comment-profile-pic" 
                    alt="${reply.username}"
                    onclick="window.location.href='/profile/${reply.username}'"
                    style="width: 24px; height: 24px; cursor:pointer;">
                <strong class="comment-username" 
                        onclick="window.location.href='/profile/${reply.username}'"
                        style="cursor:pointer;">
                  ${reply.username}
                </strong>
              </div>
              <div class="comment-content">${reply.content}</div>
            </div>
          `;
        });
          commentHtml += '</div>';
        }
        
        commentDiv.innerHTML = commentHtml;
        container.appendChild(commentDiv);

        // Ajouter l'√©v√©nement pour r√©pondre
        const replyBtn = commentDiv.querySelector('.reply-btn');
        replyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // Supprimer tout formulaire de r√©ponse existant
          const existingForm = commentDiv.querySelector('.reply-form');
          if (existingForm) existingForm.remove();
          
          // Cr√©er le formulaire de r√©ponse
          const replyForm = document.createElement('form');
          replyForm.classList.add('reply-form');
          replyForm.style.marginTop = '8px';
          replyForm.innerHTML = `
            <textarea name="replyContent" placeholder="R√©pondre √† ${comment.username}..." required 
                      style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); 
                             background: rgba(255,255,255,0.05); color: #e6eef8; font-size: 13px;"></textarea>
            <div style="display: flex; gap: 8px; margin-top: 6px;">
              <button type="submit" style="padding: 6px 12px; background: linear-gradient(90deg,#06b6d4,#7c3aed); 
                     border: none; border-radius: 6px; color: #021024; font-size: 13px; cursor: pointer;">
                Envoyer
              </button>
              <button type="button" class="cancel-reply" style="padding: 6px 12px; background: rgba(255,255,255,0.1); 
                     border: none; border-radius: 6px; color: var(--muted); font-size: 13px; cursor: pointer;">
                Annuler
              </button>
            </div>
          `;
          
          commentDiv.appendChild(replyForm);
          
          // Annuler la r√©ponse
          replyForm.querySelector('.cancel-reply').addEventListener('click', () => {
            replyForm.remove();
          });
          
          // Envoyer la r√©ponse
          replyForm.addEventListener('submit', async (submitEvent) => {
            submitEvent.preventDefault();
            const content = replyForm.replyContent.value.trim();
            if (!content) return;
            
            try {
              const res = await fetch(`/reply_comment/${tweetId}/${idx}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
              });
              
              const result = await res.json();
              if (result.success) {
                await loadComments(tweetId); // Recharger les commentaires
              } else {
                alert(result.message);
              }
            } catch (error) {
              console.error('Error replying:', error);
              alert('Erreur lors de l\'envoi de la r√©ponse');
            }
          });
        });
      });
    } else {
      container.innerHTML = '<p style="text-align:center; color:var(--muted); padding: 20px;">Aucun commentaire pour le moment.</p>';
    }
  } catch (error) {
    console.error('Error loading comments:', error);
    container.innerHTML = '<p style="color:#f87171; text-align:center; padding: 20px;">Erreur de chargement des commentaires</p>';
  }
}

// Ajouter un nouveau commentaire
document.getElementById('newCommentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const content = e.target.content.value.trim();
  if (!content || !currentTweetId) return;

  const formData = new FormData();
  formData.append('content', content);

  try {
    const res = await fetch(`/comment/${currentTweetId}`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (data.success) {
      e.target.content.value = '';
      await loadComments(currentTweetId);
    } else {
      alert(data.message);
    }
  } catch (error) {
    console.error('Error adding comment:', error);
    alert('Erreur lors de l\'ajout du commentaire');
  }
});

/* AUTO-HIDE FLASH MESSAGES */
document.addEventListener('DOMContentLoaded', () => {
  const flashMessages = document.querySelectorAll('.flash-message');
  
  flashMessages.forEach(message => {
    const delay = message.dataset.delay || 3000; // Default 3 seconds
    
    // Auto-remove after delay
    setTimeout(() => {
      message.style.animation = 'fadeOut 0.3s ease-out forwards';
      setTimeout(() => message.remove(), 300); // Wait for animation
    }, delay);
    
    // Remove on click (optional)
    message.addEventListener('click', (e) => {
      if (!e.target.classList.contains('flash-close')) {
        message.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => message.remove(), 300);
      }
    });
  });
});
</script>



</div>
</body>
</html>
